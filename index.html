<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Travimo AR - Verifica√ß√£o</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* UI GERAL */
        .ui-layer { position: absolute; z-index: 100; pointer-events: none; width: 100%; height: 100%; top: 0; left: 0; }
        .interactive { pointer-events: auto; }

        /* MENSAGEM TOPO */
        #info-msg {
            position: absolute; top: 20px; width: 100%; text-align: center; 
            color: rgba(255,255,255,0.8); font-size: 14px; text-shadow: 1px 1px 2px black;
        }

        /* CARD DE PROPRIEDADES (BIM) */
        #prop-card {
            position: absolute; bottom: 20px; left: 5%; width: 90%; 
            background: rgba(15, 23, 42, 0.95); border-left: 4px solid #00b894;
            border-radius: 8px; padding: 15px; box-sizing: border-box;
            display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            transition: transform 0.3s ease;
        }
        .prop-title { color: #fff; font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .prop-detail { color: #00b894; font-size: 14px; font-family: monospace; margin-bottom: 5px; }
        .prop-meta { color: #94a3b8; font-size: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .close-prop { position: absolute; top: 10px; right: 10px; color: #fff; background: none; border: none; font-size: 20px; }

        /* MENU DE AJUSTE (MOVER/GIRAR) */
        #adjust-panel {
            position: absolute; bottom: 100px; width: 100%; text-align: center;
            display: none; /* Escondido por padr√£o */
        }
        .control-box {
            display: inline-block; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        input[type=range] { vertical-align: middle; accent-color: #e17055; width: 150px; }
        .label-rot { color: white; font-size: 12px; margin-right: 10px; }

        /* BOT√ïES DE MODO */
        #mode-toggle {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.6); color: white; border: 1px solid white;
            padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 12px;
        }
        #mode-toggle.active { background: #e17055; border-color: #e17055; }

    </style>
</head>
<body>

    <div class="ui-layer">
        <div id="info-msg">Aponte para o ch√£o e clique em START AR</div>
        
        <button id="mode-toggle" class="interactive" style="display:none;">üîì MOVER OBRA</button>

        <div id="adjust-panel">
            <div class="control-box interactive">
                <span class="label-rot">GIRAR:</span>
                <input type="range" id="rot-slider" min="0" max="6.28" step="0.05" value="0">
                <div style="font-size:10px; color:#aaa; margin-top:5px;">Arraste na tela para Mover</div>
            </div>
        </div>

        <div id="prop-card" class="interactive">
            <button class="close-prop" onclick="deselect()">√ó</button>
            <div class="prop-title" id="p-name">VIGA V1</div>
            <div class="prop-detail" id="p-profile">W 200x15.5</div>
            <div class="prop-meta">
                <div>Comprimento: <span id="p-len" style="color:#fff">5000mm</span></div>
                <div>Status: <span id="p-status" style="color:#fff">MONTAGEM</span></div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        let container;
        let camera, scene, renderer;
        let controller;
        let reticle; // Mira para posicionamento inicial
        
        let shedGroup; // Grupo principal da obra
        let hitTestSource = null;
        let hitTestSourceRequested = false;

        // ESTADOS DA APP
        let isPlaced = false; // Se a obra j√° foi colocada no ch√£o
        let isMoveMode = false; // Se estamos no modo de ajuste
        let selectedMesh = null; // Pe√ßa selecionada atualmente

        // RAYCASTER (Para clicar nas pe√ßas)
        const raycaster = new THREE.Raycaster();
        const tempMatrix = new THREE.Matrix4(); // Auxiliar para matem√°tica

        // ELEMENTOS DOM
        const btnMode = document.getElementById('mode-toggle');
        const panelAdjust = document.getElementById('adjust-panel');
        const cardProp = document.getElementById('prop-card');
        const msgInfo = document.getElementById('info-msg');

        init();
        animate();

        function init() {
            container = document.createElement('div');
            document.body.appendChild(container);

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            // LUZES
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            hemiLight.position.set(0.5, 1, 0.25);
            scene.add(hemiLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 3);
            dirLight.position.set(0, 10, 5);
            scene.add(dirLight);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);

            // BOT√ÉO AR
            const arBtn = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
            document.body.appendChild(arBtn);

            // CONTROLADOR (O toque na tela)
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect); // Evento de toque
            scene.add(controller);

            // RET√çCULA (A mira no ch√£o)
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0xffffff }) // Mira branca inicialmente
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            // CRIA A OBRA (Mas deixa invis√≠vel at√© posicionar)
            buildShed();
            shedGroup.visible = false;

            // EVENTOS DE UI
            btnMode.addEventListener('click', toggleMoveMode);
            
            document.getElementById('rot-slider').addEventListener('input', (e) => {
                if(shedGroup) shedGroup.rotation.y = parseFloat(e.target.value);
            });

            // Torna a fun√ß√£o deselect global para o bot√£o HTML chamar
            window.deselect = deselectPart;

            window.addEventListener('resize', onWindowResize);
        }

        // --- CONSTRU√á√ÉO DO GALP√ÉO COM DADOS BIM ---
        function buildShed() {
            shedGroup = new THREE.Group();
            scene.add(shedGroup);

            // Par√¢metros
            const numBays = 3; const bayLen = 5.0; const shedW = 10.0; const colH = 4.0; const roofH = 1.5;
            const halfSpan = shedW / 2; const roofAngle = Math.atan2(roofH, halfSpan); const rafterLen = Math.sqrt(halfSpan**2 + roofH**2);

            // Fun√ß√£o Helper Inteligente
            const createPart = (type, name, w, h, d, x, y, z, rotZ, color, status) => {
                const geometry = new THREE.BoxGeometry(w, h, d);
                const material = new THREE.MeshStandardMaterial({ color: color, roughness: 0.6, metalness: 0.2 });
                const mesh = new THREE.Mesh(geometry, material);
                
                // Posi√ß√£o (Centralizando o galp√£o no X e Z)
                mesh.position.set(x - shedW/2, y, z - (numBays*bayLen)/2);
                if (rotZ) mesh.rotation.z = rotZ;
                
                // *** DADOS BIM (METADATA) ***
                // Geramos um nome de perfil baseado nas medidas
                let perfil = "Chapa";
                const mmW = (w*1000).toFixed(0); const mmH = (h*1000).toFixed(0); const mmD = (d*1000).toFixed(0);
                
                if(type === 'PILAR') perfil = `W ${mmW}x${mmD}`;
                else if(type === 'VIGA') perfil = `I ${mmW}x${mmH}`; // Viga usa largura visual
                else if(type === 'TERCA') perfil = `U ${mmW}x${mmH}`;
                
                // Salva dentro da pe√ßa
                mesh.userData = {
                    name: name,
                    profile: perfil,
                    length: (type === 'TERCA' ? d : (type === 'PILAR' ? h : w) * 1000).toFixed(0) + 'mm',
                    status: status,
                    originalColor: color // Para restaurar ao deselecionar
                };

                shedGroup.add(mesh);
            };

            const C_PILAR = 0x0984e3; const C_VIGA = 0xe17055; const C_TERCA = 0x636e72; const C_BASE = 0x2d3436;

            for (let i = 0; i <= numBays; i++) {
                const z = i * bayLen;
                const s = (i===0 || i===numBays) ? 'MONTAGEM' : 'PINTURA'; // Exemplo de status
                
                // Pilares
                createPart('PILAR', `Pilar P${i+1}E`, 0.2, colH, 0.2, 0, colH/2, z, 0, C_PILAR, s);
                createPart('PILAR', `Pilar P${i+1}D`, 0.2, colH, 0.2, shedW, colH/2, z, 0, C_PILAR, s);
                
                // Vigas
                const rX = halfSpan / 2; const rY = colH + (roofH / 2);
                createPart('VIGA', `Viga V${i+1}E`, rafterLen, 0.25, 0.1, rX, rY, z, roofAngle, C_VIGA, 'CORTE');
                createPart('VIGA', `Viga V${i+1}D`, rafterLen, 0.25, 0.1, shedW - rX, rY, z, -roofAngle, C_VIGA, 'CORTE');
            }

            const purlinPositions = [0.0, 1.25, 2.5, 3.75, 5.0]; const totalLen = numBays * bayLen;
            purlinPositions.forEach((xOff, idx) => {
                let hY = colH + (xOff * Math.tan(roofAngle)) + 0.15;
                createPart('TERCA', `Ter√ßa L${idx+1}`, 0.1, 0.05, totalLen, xOff, hY, totalLen/2, roofAngle, C_TERCA, 'EXPEDICAO');
                createPart('TERCA', `Ter√ßa L${idx+1}`, 0.1, 0.05, totalLen, shedW - xOff, hY, totalLen/2, -roofAngle, C_TERCA, 'EXPEDICAO');
            });
        }

        // --- L√ìGICA DE INTERA√á√ÉO (TOQUE NA TELA) ---
        function onSelect() {
            // Cen√°rio 1: Obra ainda n√£o posicionada -> Posiciona onde a mira est√°
            if (!isPlaced) {
                if (reticle.visible) {
                    shedGroup.position.setFromMatrixPosition(reticle.matrix);
                    shedGroup.visible = true;
                    isPlaced = true;
                    
                    // Mostra bot√µes de controle
                    btnMode.style.display = 'block';
                    msgInfo.innerText = "Toque em uma pe√ßa para ver detalhes";
                    
                    // Esconde a mira, n√£o precisamos mais dela por enquanto
                    reticle.visible = false; 
                }
                return;
            }

            // Cen√°rio 2: Modo de Ajuste (Mover Obra) -> Move para onde clicou
            if (isMoveMode) {
                if (reticle.visible) {
                    // Move a obra para a nova posi√ß√£o da mira (mantendo a rota√ß√£o Y atual)
                    const currentRot = shedGroup.rotation.y;
                    shedGroup.position.setFromMatrixPosition(reticle.matrix);
                    shedGroup.rotation.y = currentRot;
                }
                return;
            }

            // Cen√°rio 3: Modo Normal -> Selecionar Pe√ßa (Raycast)
            // Cria um raio a partir da posi√ß√£o do controlador (celular)
            tempMatrix.identity().extractRotation(controller.matrixWorld);
            raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);
            raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);

            const intersects = raycaster.intersectObjects(shedGroup.children);

            if (intersects.length > 0) {
                selectPart(intersects[0].object);
            } else {
                deselectPart(); // Clicou no vazio, deseleciona
            }
        }

        function selectPart(mesh) {
            // Se j√° tem um selecionado, restaura a cor dele
            if (selectedMesh) {
                selectedMesh.material.color.setHex(selectedMesh.userData.originalColor);
                selectedMesh.material.emissive.setHex(0x000000);
            }

            selectedMesh = mesh;
            
            // Highlight (Amarelo Neon)
            mesh.material.color.setHex(0xffff00);
            mesh.material.emissive.setHex(0x333300);

            // Preenche e Mostra Card
            document.getElementById('p-name').innerText = mesh.userData.name;
            document.getElementById('p-profile').innerText = mesh.userData.profile;
            document.getElementById('p-len').innerText = mesh.userData.length;
            document.getElementById('p-status').innerText = mesh.userData.status;
            
            cardProp.style.display = 'block';
        }

        function deselectPart() {
            if (selectedMesh) {
                selectedMesh.material.color.setHex(selectedMesh.userData.originalColor);
                selectedMesh.material.emissive.setHex(0x000000);
                selectedMesh = null;
            }
            cardProp.style.display = 'none';
        }

        function toggleMoveMode() {
            isMoveMode = !isMoveMode;
            if(isMoveMode) {
                btnMode.innerText = "üîí TRAVAR POSI√á√ÉO";
                btnMode.classList.add('active');
                panelAdjust.style.display = 'block';
                msgInfo.innerText = "Arraste no ch√£o para mover. Use o slider para girar.";
                reticle.visible = true; // Mostra mira para reposicionar
                deselectPart(); // Fecha popup se tiver aberto
            } else {
                btnMode.innerText = "üîì MOVER OBRA";
                btnMode.classList.remove('active');
                panelAdjust.style.display = 'none';
                msgInfo.innerText = "Toque em uma pe√ßa para ver detalhes";
                reticle.visible = false;
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render(timestamp, frame) {
            // L√≥gica do WebXR Hit Test (Detectar ch√£o)
            if (frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                if (hitTestSourceRequested === false) {
                    session.requestReferenceSpace('viewer').then(function (referenceSpace) {
                        session.requestHitTestSource({ space: referenceSpace }).then(function (source) {
                            hitTestSource = source;
                        });
                    });

                    session.addEventListener('end', function () {
                        hitTestSourceRequested = false;
                        hitTestSource = null;
                    });

                    hitTestSourceRequested = true;
                }

                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);

                    // S√≥ mostra a mira se n√£o tivermos colocado a obra, OU se estivermos movendo ela
                    if (hitTestResults.length > 0 && (!isPlaced || isMoveMode)) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                    } else {
                        reticle.visible = false;
                    }
                }
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
